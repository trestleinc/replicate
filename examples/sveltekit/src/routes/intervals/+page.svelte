<script lang="ts">
  import { useLiveQuery } from "@tanstack/svelte-db";
  import { getFilterContext } from "$lib/contexts/filters.svelte";
  import IntervalListSkeleton from "$lib/components/IntervalListSkeleton.svelte";
  import { intervals as intervalsLazy } from "$collections/useIntervals";
  import * as Table from "$lib/components/ui/table/index.js";
  import {
    createSvelteTable,
    FlexRender,
    renderComponent,
    getCoreRowModel,
    getFilteredRowModel,
    getSortedRowModel,
    type ColumnDef,
    type SortingState,
    type ColumnFiltersState,
  } from "$lib/components/ui/data-table";
  import type { Interval } from "$lib/types";
  import StatusCell from "./StatusCell.svelte";
  import PriorityCell from "./PriorityCell.svelte";
  import ActionsCell from "./ActionsCell.svelte";
  import TitleCell from "./TitleCell.svelte";

  const collection = intervalsLazy.get();
  const intervalsQuery = useLiveQuery(collection);
  const filters = getFilterContext();

  const intervals = $derived(intervalsQuery.data ?? []) as Interval[];

  let sorting = $state<SortingState>([{ id: "updatedAt", desc: true }]);
  let columnFilters = $state<ColumnFiltersState>([]);

  $effect(() => {
    const newFilters: ColumnFiltersState = [];
    if (filters.statusFilter) {
      newFilters.push({ id: "status", value: filters.statusFilter });
    }
    if (filters.priorityFilter) {
      newFilters.push({ id: "priority", value: filters.priorityFilter });
    }
    columnFilters = newFilters;
  });

  const columns: ColumnDef<Interval>[] = [
    {
      accessorKey: "status",
      filterFn: "equals",
      cell: ({ row }) => renderComponent(StatusCell, { interval: row.original }),
    },
    {
      accessorKey: "title",
      cell: ({ row }) => renderComponent(TitleCell, { interval: row.original }),
    },
    {
      accessorKey: "priority",
      filterFn: "equals",
      cell: ({ row }) => renderComponent(PriorityCell, { interval: row.original }),
    },
    {
      accessorKey: "updatedAt",
      enableHiding: true,
    },
    {
      id: "actions",
      cell: ({ row }) => renderComponent(ActionsCell, { interval: row.original }),
    },
  ];

  const table = createSvelteTable<Interval>({
    get data() { return intervals; },
    columns,
    state: {
      get sorting() { return sorting; },
      get columnFilters() { return columnFilters; },
      get columnVisibility() { return { updatedAt: false }; },
    },
    onSortingChange: (updater) => {
      sorting = typeof updater === "function" ? updater(sorting) : updater;
    },
    onColumnFiltersChange: (updater) => {
      columnFilters = typeof updater === "function" ? updater(columnFilters) : updater;
    },
    getCoreRowModel: getCoreRowModel(),
    getSortedRowModel: getSortedRowModel(),
    getFilteredRowModel: getFilteredRowModel(),
  });

  const rows = $derived(table.getRowModel().rows);
</script>

{#if intervalsQuery.isLoading}
  <IntervalListSkeleton />
{:else}
<div class="flex-1 flex flex-col min-h-0">
  {#if rows.length === 0}
    <div class="flex flex-col items-center justify-center py-16 text-muted-foreground text-center">
      {#if intervals.length === 0}
        <p class="m-0">No intervals yet</p>
        <p class="text-xs opacity-60 mt-1">
          Press
          <kbd class="kbd-key">&#x2325;</kbd>
          <kbd class="kbd-key">N</kbd>
          to create your first interval
        </p>
      {:else}
        <p class="m-0">No intervals match your filters</p>
      {/if}
    </div>
  {:else}
    <div class="flex-1 overflow-auto">
      <Table.Root>
        <Table.Body>
          {#each rows as row (row.id)}
            <Table.Row class="group">
              {#each row.getVisibleCells() as cell (cell.id)}
                <Table.Cell class={cell.column.id === "title" ? "w-full" : "w-8 p-2"}>
                  <FlexRender content={cell.column.columnDef.cell} context={cell.getContext()} />
                </Table.Cell>
              {/each}
            </Table.Row>
          {/each}
        </Table.Body>
      </Table.Root>
    </div>
  {/if}
</div>
{/if}
